---
name: dibsy
logger: ['Stderr', 'log_level', 'info']

variables:
   - &base_image     'alpine:3.6'
   - &version_major           '0'
   - &version_minor           '4'
   - &version_patch           '1'
   - &username             'user'
   - &groupname            'user'
   - &appdir               '/app'
   - function: &dibspath
      ['join', '/', *appdir, 'bin/dibs']
   - function: &version
      ['join', '.', *version_major, *version_minor, *version_patch]
   - function: &version_maj_min
      ['join', '.', *version_major, *version_minor]
   - &basic_commit
      entrypoint: [ ]
      cmd: [ '/bin/sh', '-l' ]
      user: root
      workdir: /root
   - &base_builder_image 'dibs-builder:0.4'
   - &base_runner_image  'dibs-runner:0.4'
   - &base_tags ['*', 'latest', *version_maj_min]
   - &extended_tags ['*', 'latest', *version_maj_min, *version]

packs:
   basic:
      type:   git
      origin: /home/poletti/sviluppo/perl/dibspack-basic

actions:
   default: [message]

   message:
      type: log
      message: |
         Howdy!

   placeholder:
      pack:
         run: |
            #!/bin/sh
            exec >&2
            printf '%s\n' 'Placeholder...'
            whoami
            env
      user: root
      commit: *basic_commit

   create-user:
      pack: basic
      path: wrapexec/suexec
      args: ['-u', *username, '-h', *appdir]
      user: root

   prereqs:
      name: install OS-level prerequisites
      pack: basic
      path: prereqs
      user: root
      commit: *basic_commit

   install_profile_exec:
      pack: basic
      path: wrapexec/install
      args: ['suexec', 'profilexec']
      user: root

   base:
      - from: *base_image
      - create-user
      - prereqs


   buildish:
      envile:
         DIBS_PREREQS: build

   'copy into src':
      pack: 'src:dibspacks/src-in-app.sh'
      args: [*username, *groupname, *appdir]
      user: root

   'build perl application':
      pack: basic
      path: perl/build
      args: ['-w', *appdir, '-V', *version]
      user: *username

   'copy with .dibsignore':
      pack: basic
      path: install/with-dibsignore
      args: ['--src', *appdir, '--dst', {path_cache: 'perl-app'}]
      user: root

   build_base:
      extends: buildish
      actions:
         - base
         - name: save builder image
           image_name: dibs-builder
           tags: *base_tags

   build_bare:
      - 'copy into src'
      - 'build perl application'
      - 'copy with .dibsignore'

   build:
      extends: buildish
      actions:
         - from: *base_builder_image
         - prereqs
         - build_bare

   buildq:
      - from: *base_builder_image
      - build_bare


   bundlish:
      envile:
         DIBS_PREREQS: bundle

   'copy built artifacts to destination':
      pack: basic
      path: install/plain-copy
      args: [{path_cache: 'perl-app'}, *appdir]
      user: root
      commit:
         entrypoint: [ "/suexec", "-r", ".", "-A", "/var/run/docker.sock",
            "--", "/profilexec", *dibspath ]
         cmd: [ "--help" ]
         workdir: *appdir

   'save bundled image':
      image_name: dibs
      tags: *base_tags

   bundle_base:
      extends: bundlish
      actions:
         - base
         - install_profile_exec
         - name: save runner image
           image_name: dibs-runner
           tags: *extended_tags

   bundle_bare:
      - 'copy built artifacts to destination'
      - 'save bundled image'

   bundle:
      extends: bundlish
      actions:
         - from: *base_runner_image
         - prereqs
         - bundle_bare

   bundleq:
      - from: *base_runner_image
      - bundle_bare
