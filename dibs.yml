---
name: dibsy
defaults:
   variables:
      - &base_image     'alpine:3.6'
      - &version_major           '0'
      - &version_minor           '3'
      - &version_patch           '1'
      - function: &version
         ['join', '.', *version_major, *version_minor, *version_patch]
      - function: &version_maj_min
         ['join', '.', *version_major, *version_minor]
      - commit: &commit
         name: dibsy
         tags: [ 'latest', *version ]
         entrypoint: [ "/suexec", "-r", ".", "-A", "/var/run/docker.sock",
               "--", "/profilexec", "/app/bin/dibs" ]
         cmd: [ '--help' ]
      - buildish: &buildish
         step: build
      - bundlish: &bundlish
         step: bundle

workflow:
   - qbuild
   - qbundle

actions:
   user: &user
      dibspack: basic
      path:     wrapexec/stripexec
      args:     ['suexec', '-u', 'user', '-h', '/app']
      user:     root
   prereqs: &prereqs
      dibspack: basic
      path:     prereqs
      user:     root
   build_bare: &build_bare
      - 'src:dibspacks/src-in-app.sh'
      - dibspack: basic
        path:     perl/build
        args:     ['-w', '/app', '-V', *version]
      - dibspack:  basic
        path:     install/with-dibsignore
        args:     ['--src', '/app', '--dst', {path_cache: 'perl-app'}]
   bundle_bare: &bundle_bare
      - dibspack: basic
        path:     install/plain-copy
        args:     [{path_cache: 'perl-app'}, '/app']
        user:     root

dibspacks:
   basic:
      type:   git
      origin: https://github.com/polettix/dibspack-basic.git
      user:   user

steps:
   builder:
      extends: *buildish
      from:    *base_image
      commit:  # explicit caching: persist although buildish
         name: 'dibs-builder'
         tags: [ 'latest', *version_maj_min ]
      actions: [*user, *prereqs]
   runner:
      extends: *bundlish
      from:    *base_image
      commit:
         name: 'dibs-runner'
         tags: [ 'latest', *version_maj_min ]
      actions:
         - [*user, *prereqs]
         - dibspack: basic
           path:     wrapexec/install
           args:     ['suexec', 'profilexec']
           user:     root
   build: &build
      extends: *buildish
      from:    'dibs-builder:0.3'
      actions: [*prereqs, *build_bare]
   bundle: &bundle
      extends: *bundlish
      from:    'dibs-runner:0.3'
      commit:  *commit
      actions: [*prereqs, *bundle_bare]
   qbuild:
      extends: build
      actions: build_bare
   qbundle:
      extends: *bundle
      actions: [*bundle_bare]
   tester:
      from: *base_image
      actions:
         - run: |
            #!/bin/sh
            printf 'I am in %s, #params = %d\n' "$PWD" "$#"
            . export-enviles.sh
            env | grep DIBS
           args: [ciao, a, tutti]
