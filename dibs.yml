---
name: dibs
steps:
   - qbuild
   - qbundle
defaults:
   variables:
      - &base_image     'alpine:3.6'
      - &version_major           '0'
      - &version_minor           '2'
      - &version_patch           '0'
      - function: &version
         ['join', '.', *version_major, *version_minor, *version_patch]
      - function: &version_maj_min
         ['join', '.', *version_major, *version_minor]
      - commit: &commit
         name: dibs
         tags: [ 'latest', *version ]
         entrypoint: [ "/suexec", "-r", ".", "-A", "/var/run/docker.sock",
               "--", "/profilexec", "/app/bin/dibs" ]
         cmd: [ '--help' ]
   dibspack:
      basic:
         type:   git
         origin: https://github.com/polettix/dibspack-basic.git
         user:   user
      prereqs_build: &prereqs_build
         type:   git
         origin: https://github.com/polettix/dibspack-basic.git
         path:   prereqs
         args:   ['-s', 'build']
         user:   root
      prereqs_bundle: &prereqs_bundle
         type:   git
         origin: https://github.com/polettix/dibspack-basic.git
         path:   prereqs
         args:   ['-s', 'bundle']
         user:   root
      user: &user
         type:   git
         origin: https://github.com/polettix/dibspack-basic.git
         path:   wrapexec/stripexec
         args:   ['suexec', '-u', 'user', '-h', '/app']
         user:   root
definitions:
   builder:
      from: *base_image
      commit:
         name: 'dibs-builder'
         tags: [ 'latest', *version_maj_min ]
      dibspacks:
         - *user
         - *prereqs_build
   runner:
      from: *base_image
      commit:
         name: 'dibs-runner'
         tags: [ 'latest', *version_maj_min ]
      dibspacks:
         - *user
         - *prereqs_bundle
         - default: basic
           path:    wrapexec/install
           args:    ['suexec', 'profilexec']
           user:    root
   build:
      from: 'dibs-builder:0.2'
      commit: no
      dibspacks:
         - *prereqs_build
         - 'src:dibspacks/src-in-app.sh'
         - default: basic
           path:    perl/build
           args:    ['-w', '/app', '-V', *version]
         - default: basic
           path:    install/with-dibsignore
           args:    ['--src', '/app', '--dst', {path_cache: 'perl-app'}]
   bundle:
      from: 'dibs-runner:0.2'
      commit: *commit
      dibspacks:
         - *prereqs_bundle
         - default: basic
           path:    install/plain-copy
           args:    [{path_cache: 'perl-app'}, '/app']
           user:    root
   qbuild:
      from: 'dibs-builder:0.2'
      commit: no
      dibspacks:
         - 'src:dibspacks/src-in-app.sh'
         - default: basic
           path:    perl/build
           args:    ['-w', '/app', '-V', *version]
         - default: basic
           path:    install/with-dibsignore
           args:    ['--src', '/app', '--dst', {path_cache: 'perl-app'}]
   qbundle:
      from: 'dibs-runner:0.2'
      commit: *commit
      dibspacks:
         - default: basic
           path:    install/plain-copy
           args:    [{path_cache: 'perl-app'}, '/app']
           user:    root
