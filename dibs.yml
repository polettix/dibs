---
name: dibs
logger:
   - Stderr
   - log_level
   - info
steps:
   - build
   - bundle
defaults:
   variables:
      - &base_image 'alpine:3.6'
      - &version 'DIBSPACK_SET_VERSION="0.001972"'
   dibspack:
      basic:
         type:   git
         origin: https://github.com/polettix/dibspack-basic.git
         user:   user
      prereqs:
         type:   git
         origin: https://github.com/polettix/dibspack-basic.git
         path:   prereqs
         user:   root
      user: &user
         type: src
         name: add user and enable for docker
         user: root
         path: dibspacks/user-docker.sh
definitions:
   builder:
      from: *base_image
      keep: yes
      name: 'dibs-builder'
      tags: [ 'latest' ]
      dibspacks:
         - *user
         - default: prereqs
           args: build
   runner:
      from: *base_image
      keep: yes
      name: 'dibs-runner'
      tags: [ 'latest' ]
      dibspacks:
         - *user
         - default: prereqs
           args: bundle
   build:
      from: 'dibs-builder:latest'
      keep: no
      dibspacks:
         - default: prereqs
           args: build
         - 'src:dibspacks/src-in-app.sh'
         - default: basic
           path: perl/build
           args: ['/app', *version]
         - default: basic
           path: install/with-dibsignore
           args: '--src /app --dst @path_cache:perl-app'
   bundle:
      from: 'dibs-runner:latest'
      keep: yes
      name: dibs
      tags: [ 'latest' ]
      entrypoint: [ '/dockexec', 'user', '/profilexec', '/app/bin/dibs' ]
      cmd: [ '--help' ]
      dibspacks:
         - default: prereqs
           args: bundle
         - default: basic
           user: root
           path: wrapexec/install
           args: ['dockexec', 'profilexec']
         - default: basic
           path: install/plain-copy
           args: '@path_cache:perl-app /app'
           user: root
